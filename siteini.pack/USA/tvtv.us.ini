**------------------------------------------------------------------------------------------------
* @header_start
* WebGrab+Plus ini for grabbing EPG data from TvGuide websites
* @Site: tvtv.us
* @MinSWversion: V2.1
*   none
* @Revision 7 - [17/01/2022] doglover
*	New website
* @Revision 6 - [05/10/2021] doglover
*	fixed channels creation (again)
* @Revision 5 - [28/09/2021] doglover
*	fixed channels creation
* @Revision 4 - [30/08/2021] doglover
*	Added logo
* @Revision 3 - [01/03/2021] doglover
*	Use of curl.  Download fails otherwise
* @Revision 2 - [30/12/2019] doglover
*	Use of a PHP script needed
* @Revision 1 - [07/09/2018] r00ty
*   Initial work on tvtv.us (and tvtv.ca separately) 
* @Remarks:
*   mostly json and on single page
* @header_end
**------------------------------------------------------------------------------------------------
site {url=tvtv.us|timezone=UTC|maxdays=7|cultureinfo=en-US|charset=UTF-8|episodesystem=onscreen|ratingsystem=US}
url_index{url ()|http://example.com}
url_index.headers {customheader=Accept-Encoding=gzip,deflate}
urldate.format {datestring|yyyy-MM-dd}

scope.range{(urlindex)|end}
global_temp_1.modify{set|'config_site_id'}
global_temp_4.modify {calculate(format=date,"yyyy-MM-dd")|'urldate'}
global_temp_3.modify {set(type=run)|curl.exe|-s "https://tvtv.us/gn/d/v1.1/stations/'global_temp_1'/airings?startDateTime='global_temp_4'T00:00:00.000Z&endDateTime='global_temp_4'T23:59:00.000Z"}
global_temp_3.modify {replace|\|| }
global_temp_5.modify {addend ()|'global_temp_3'}
*global_temp_5.modify {(debug)}
end_scope
**
index_urlchannellogo.modify {addstart|http://tvtv.tmsimg.com/assets/s'global_temp_1'_ll_h15_ab.png?w=360&h=270}
index_showsplit.modify {substring (type=regex)|'global_temp_5' (\{\"startTime\":.*?\"station\")}
*index_showsplit.modify {(debug)}
**
index_start.scrub {single|"startTime":"||Z",|",}
index_stop.scrub {single|"endTime":"||Z",|",}

index_description.scrub {single|"longDescription":"||",|",}
index_temp_1.scrub {single|"shortDescription":"||",|",}
index_description.modify {addstart ('index_description' = "")|'index_temo_1'}
index_title.scrub {single|"title":"||",|",}

index_subtitle.scrub {single|"episodeTitle"|:"|",|",}
index_temp_3.scrub {single|"eventTitle":"||",|",}
index_subtitle.modify {addstart ('index_temp_3' not "")|'index_temp_3'}
index_title.modify {replace("Movie")|'index_title'|'index_subtitle'}
index_subtitle.modify {remove('index_title')|'index_subtitle'} 
index_category.scrub {single|"subType":"||",|",}
index_rating.scrub {single|"ratings":|"code":"|"|]}
index_showicon.scrub {single|"preferredImage":|"uri":"|",|}} 
index_showicon.modify {addstart ('index_showicon' not "")|http://tvtv.tmsimg.com/}
**
index_category.modify {replace|,|\|}
index_actor.scrub {multi (separator=",")|"topCast":[|||]}
index_actor.modify {remove|"}
index_actor.modify {cleanup}
*index_director.scrub{single(separator=",")|"director":"||",|",}
*index_director.modify {cleanup}
*index_productiondate.scrub {single|"year"|:"|",|",}
index_episode.scrub {single|"episodeNum":||,|,"}
index_episode.modify {addstart ('index_episode' not "")|E}
index_temp_2.scrub {single|"seasonNum":||,|,"}
index_temp_2.modify {addstart ('index_temp_2' not "")|S}
index_episode.modify {addstart ('index_temp_2' not "")|'index_temp_2'}

index_title.modify {cleanup}
index_subtitle.modify {cleanup}
index_description.modify {cleanup}
index_description.modify {remove|\}
index_category.modify {cleanup}
**
**  _  _  _  _  _  _  _  _  _  _  _  _  _  _  _  _  _  _  _  _  _  _  _  _  _  _  _  _  _  _  _  _
**      #####  CHANNEL FILE CREATION (only to create the xxx-channel.xml file)
**
** Note, the 36212D is the line-up for New York DirecTV. You can get your own lineup by visiting http://tvtv.us enter your location.
** It should then load a URL like: https://tvtv.us/ny/new-york/luUSA-DITV501-DEFAULT for which you just take everything after "lu" as your lineup ID
** Then you can add a line like the following (replacing the site_id value with your own linup:  (the value after lu)
**     <channel update="i" site="tvtv.us" site_id="USA-DITV501-DEFAULT" xmltv_id="tvtv New York">tvtv New York</channel>
** It will then generate a channel file for your line-up
** @auto_xml_channel_start
*global_temp_1.modify{set|'config_site_id'}
*global_temp_3.modify {set(type=run)|curl.exe|-s "https://tvtv.us/gn/d/v1.1/lineups/'global_temp_1'/channels?enhancedCallSign=true&imageSize=Sm"}
*index_site_id.scrub {multi|dummy}
*index_site_id.modify {substring (type=regex)|'global_temp_3' ({"stationId":".*?}})}
*index_site_channel.modify {substring (type=regex)|'index_site_id' \"callSign\":\"(.*?)\"channel\"}
*index_site_channel.modify {remove (type=regex)|(\",\".*?\"affiliateCallSign\")}
*index_site_channel.modify {remove (type=regex)|(\",\".*)}
*index_site_channel.modify {replace|"| - }
*index_site_channel.modify {cleanup}
*index_site_id.modify {substring (type=regex)|'index_site_id' \"stationId\":\"(.*?)\",}
*index_site_id.modify {cleanup(removeduplicates=equal,100 link="index_site_channel")}
** @auto_xml_channel_end


